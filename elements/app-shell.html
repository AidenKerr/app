<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="common/app-icons.html">
<link rel="import" href="providers/provider-party.html">
<link rel="import" href="views/view-home.html">
<link rel="import" href="views/view-party.html">

<dom-module id="app-shell">
    <template>
        <style>
            :host {
                --primary-color: #951518;
                --primary-color-dark: #731417;
                --secondary-color: #1c1f24;

                --primary-text-color: white;
                --secondary-text-color: #a9a9a9;

                background: var(--secondary-color);

                display: flex;
                justify-content: center;
                flex-direction: column;

                min-height: 100vh;
            }

            iron-pages {
                height: 100%;
            }

            iron-pages > * {
                height: 100%;
            }

            iron-pages > .centered {
                margin: 0 auto;
                max-width: 600px;
            }

            paper-spinner-lite {
                display: flex;
                justify-self: center;
                --paper-spinner-color: var(--primary-color);
            }
        </style>

        <template is="dom-if" if="[[!_cordova]]">
            <app-location route="{{route}}"></app-location>
        </template>
        <app-route route="{{route}}"
                   pattern="/:view"
                   data="{{routeData}}"
                   tail="{{subroute}}">
        </app-route>

        <firebase-app api-key="AIzaSyDl9A10FlNzy3smQQWp11RzYVPs2FgOzMg"
                      auth-domain="festify-dev.firebaseapp.com"
                      database-url="https://festify-dev.firebaseio.com">
        </firebase-app>
        <firebase-auth id="fbAuth"
                       status-known="{{fbStatusKnown}}"
                       signed-in="{{fbSignedIn}}"
                       user="{{state.authedUser}}">
        </firebase-auth>

        <app-route route="{{route}}"
                   pattern="/party/:partyId"
                   data="{{partyRouteData}}"
                   active="{{partyViewActive}}">
        </app-route>
        <provider-party id="partyProvider"
                        data="{{state.party}}"
                        fb-id="{{state.partyId}}"
                        state="[[state]]"
                        on-fb-id-changed="_currentPartyIdChanged">
        </provider-party>

        <template is="dom-if" if="[[fbSignedIn]]">
            <iron-pages selected="[[currentView]]"
                        attr-for-selected="view"
                        selected-attribute="active"
                        role="main">
                <view-home class="centered" view="home" route="{{subroute}}"></view-home>
                <view-party class="centered" view="party" state="[[state]]" route="{{subroute}}"></view-party>
            </iron-pages>
        </template>
        <template is="dom-if" if="[[!fbSignedIn]]">
            <paper-spinner active></paper-spinner>
        </template>
    </template>

    <script>
        Polymer({
            is: 'app-shell',

            properties: {
                currentView: {
                    type: String
                },
                fbSignedIn: {
                    type: Boolean
                },
                fbStatusKnown: {
                    type: Boolean
                },
                partyRouteData: {
                    type: Object
                },
                state: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                _cordova: {
                    type: Boolean,
                    value: function() {return !!window.cordova},
                    readonly: true
                }
            },

            listeners: {
                'host-createNewParty': '_createNewParty',
                'join-openParty': '_openParty'
            },

            observers: [
                '_partyRouteIdChanged(partyRouteData.partyId)',
                '_routePageChanged(routeData.view)',
                '_loginStateChanged(fbStatusKnown, fbSignedIn)'
            ],

            ready: function() {
                if(window.cordova) {
                    this.set("route", {path: "/home/host", prefix: "", __queryParams: {}});
                }
            },

            // Property Observers

            _currentPartyIdChanged: function (ev) {
                this.set('route.path', '/party/' + ev.detail.value);
            },

            _loginStateChanged: function (statusKnown, signedIn) {
                if (statusKnown) {
                    if (!signedIn) {
                        this.$.fbAuth.signInAnonymously()
                            .then(function (user) {
                                console.debug("We're logged in", user.uid);
                            })
                            .catch(function (err) {
                                console.error("Error while authing with Firebase", err);
                            });
                    } else {
                        console.debug("We're already logged in with", this.$.fbAuth.user.uid);
                    }
                }
            },

            _partyRouteIdChanged: function (partyId) {
                if (partyId && partyId.length > 0) {
                    this.set('state.partyId', partyId);
                }
            },

            _routePageChanged: function (page) {
                if (page && page.length > 0) {
                    this.set('currentView', page);
                } else {
                    this.set('route.path', '/home');
                    this.set('currentView', 'home');
                }
            },

            // Actions

            _openParty: function (ev) {
                this.$.partyProvider.set('shortId', ev.detail.shortId);
            },

            _createNewParty: function () {
                this.$.partyProvider.createNewParty();
            }
        });
    </script>
</dom-module>
