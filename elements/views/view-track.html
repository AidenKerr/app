<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../common/behavior-app-state.html">
<link rel="import" href="../common/shared-styles.html">
<link rel="import" href="../common/size-aware-image.html">
<link rel="import" href="../utils/lodash.html">

<dom-module id="view-track">
    <template>
        <style include="shared-styles"></style>
        <style>
            :host {
                display: flex;
                flex-direction: row;
                align-items: center;

                height: 60px;
                padding: 5px;

                box-sizing: content-box;
            }

            .metadata-wrapper {
                overflow: hidden;
            }

            size-aware-image {
                background: rgba(0, 0, 0, 0.2);
                flex-shrink: 0;
                height: 50px;
                margin: 5px 15px 5px 5px;
                width: 50px;

                --size-aware-image-container: {
                    border-radius: 5px;
                }
            }

            h2 {
                margin: 0;
                font-weight: 400;
                font-size: 18px;
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
            }

            aside {
                margin: 2px 0;
                font-weight: 300;
                font-size: 16px;
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
            }

            .icon-wrapper {
                margin-left: auto;
                flex-basis: 50px;
            }

            paper-icon-button {
                margin-left: 5px;
                height: 50px;
                width: 50px;
            }
        </style>

        <firebase-document path="[[_getFirebaseVotesPath(state, track.*)]]" data="{{_hasVoted}}"></firebase-document>

        <size-aware-image sorted-sizes="[[_getCoverImage(metadata.*, track)]]"></size-aware-image>
        <div class="metadata-wrapper">
            <h2>[[track.name]]</h2>
            <aside>
                <a>[[_getArtistName(metadata.*, track)]]</a>
                <span>&middot;</span>
                <span>[[_getVoteString(track)]]</span>
            </aside>
        </div>
        <div class="icon-wrapper">
            <paper-icon-button icon="[[_getLikeButtonIcon(track, _hasVoted)]]" on-tap="_tapLikeIcon"></paper-icon-button>
        </div>
    </template>
    <script>
        Polymer({
            is: 'view-track',

            behaviors: [FestifyBehaviors.StateBehavior],

            properties: {
                _hasVoted: {
                    type: Boolean
                },
                metadata: {
                    type: Object
                },
                track: {
                    type: Object
                }
            },

            _getArtistName: function (metaChange, track) {
                return _.get(metaChange.base, [track.reference.provider, track.reference.id, 'artistName']);
            },

            _getCoverImage: function (metaChange, track) {
                return _.get(metaChange.base, [track.reference.provider, track.reference.id, 'cover']);
            },

            _getFirebaseVotesPath: function (state, trackChange) {
                const partyId = state.partyId;
                const track = trackChange.base;
                return partyId && partyId.length > 0 && track ?
                    '/votes/' + partyId + '/' + track.$key + '/' + state.auth.authedUser.uid :
                    '';
            },

            _getLikeButtonIcon: function (track, hasVoted) {
                return track.played_at && !track.isFromSearch ?
                    'av:play-arrow' :
                    hasVoted === true ? // We get an empty object from firebase once the vote is deleted
                        'favorite' :
                        track.vote_count > 0 || track.is_fallback ?
                            'favorite-border' :
                            'add';
            },

            _getVoteString: function (track) {
                return (track.vote_count > 1) ?
                    track.vote_count + ' Votes' :
                    (track.vote_count == 1) ?
                        'One Vote' :
                        track.isFromSearch ?
                            'Not in queue' :
                            'Fallback Track';
            },

            _tapLikeIcon: function () {
                this.fire('track-toggleVote', { track: this.track });
                setTimeout(() => this.notifyPath('track.$key'), 30);
            }
        });
    </script>
</dom-module>
