<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../utils/lodash.html">

<dom-module id="provider-spotify">
    <template>
        <iron-ajax id="trackSearchAjax"
                   url="https://api.spotify.com/v1/search"
                   handle-as="json">
        </iron-ajax>
    </template>
    <script>
        Polymer({
            is: 'provider-spotify',

            properties: {
                market: {
                    type: String,
                    value: 'DE'
                },
                _request: {
                    type: Object
                }
            },

            search: function (query) {
                if (this._request) {
                    this._request.abort();
                }

                var xhr = this.$.trackSearchAjax;
                xhr.set('params', {
                    market: this.market,
                    q: query + '*',
                    type: 'track'
                });

                this.set('_request', xhr.generateRequest());
                return this._request.completes
                    .then(function (xhr) {
                        this.set('_request', null);
                        return Promise.resolve(xhr.response.tracks.items.map(function (track) {
                            return {
                                artists: track.artists.map(function (artist) {
                                    return artist.name;
                                }),
                                name: track.name,
                                reference: {
                                    id: track.id,
                                    provider: 'spotify'
                                }
                            }
                        }));
                    }.bind(this));
            }
        });
    </script>
</dom-module>
