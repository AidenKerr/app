<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../utils/lodash.html">

<dom-module id="provider-spotify">
    <template>
        <iron-ajax id="trackSearchAjax"
                   url="https://api.spotify.com/v1/search"
                   handle-as="json">
        </iron-ajax>
    </template>
    <script>
        Polymer({
            is: 'provider-spotify',

            properties: {
                limit: {
                    type: Number,
                    value: 20
                },
                market: {
                    type: String,
                    value: 'DE'
                },
                _request: {
                    type: Object
                }
            },

            search: function (query) {
                if (query.length < 2) {
                    return;
                }
                if (this._request) {
                    this._request.abort();
                }

                var xhr = this.$.trackSearchAjax;
                xhr.set('params', {
                    limit: this.limit,
                    q: query + '*',
                    type: 'track'
                });
                if (this.market) {
                    xhr.set('params.market', this.market);
                }

                this.set('_request', xhr.generateRequest());
                return this._request.completes
                    .then(function (xhr) {
                        this.set('_request', null);

                        return _.get(xhr, 'response.tracks.items', [])
                                .map(function (track) {
                                    return {
                                        name: track.name,
                                        reference: {
                                            id: track.id,
                                            provider: 'spotify'
                                        }
                                    }
                                });
                    }.bind(this));
            }
        });
    </script>
</dom-module>
