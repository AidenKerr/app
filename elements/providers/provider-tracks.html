<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/legacy/class.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-database-script.html">
<link rel="import" href="../behaviors/behavior-app-state.html">
<link rel="import" href="../behaviors/behavior-firebase-paths.html">
<link rel="import" href="../utils/lodash.html">

<script>
    class TracksProvider extends FestifyBehaviors.FbPaths(Polymer.mixinBehaviors([
        FestifyBehaviors.StateBehavior
    ], Polymer.Element)) {
        static get is() {
            return 'provider-tracks';
        }

        static get properties() {
            return {
                limit: {
                    type: Number,
                    value: 50
                },
                offset: {
                    type: Number,
                    value: 0
                },
                tracks: {
                    type: Array,
                    notify: true,
                    value: () => ([])
                },
                _fbQuery: {
                    type: firebase.database.Query,
                    computed: '_computeQuery(state.partyId, limit)',
                    observer: '_queryChanged'
                }
            };
        }

        static get observers() {
            return [
                '_tracksChanged(tracks.*)'
            ];
        }

        removeTrack(track, moveToHistory) {
            if (!track || !this.state || !this.state.isHost) {
                return;
            }

            const partyId = this.state.partyId;
            const trackId = this._generateFbId(track);

            const updates = [
                firebase.database()
                    .ref(this._getFbTracksPath(partyId))
                    .child(trackId)
                    .set(null),
                firebase.database()
                    .ref(this._getFbVotesPath(partyId))
                    .child(trackId)
                    .set(null),
                firebase.database()
                    .ref(this._getFbVotesByUserPath(partyId))
                    .transaction(votes => {
                        return _.mapValues(votes, userVotes => _.omit(userVotes, trackId));
                    })
            ];

            if (moveToHistory) {
                updates.push(
                    firebase.database()
                        .ref(this._getFbHistoryPath(partyId))
                        .push(track)
                );
            }

            return Promise.all(updates);
        }

        _computeQuery(partyId, limit) {
            if (!partyId) {
                return null;
            }

            let query = firebase.database().ref(this._getFbTracksPath(partyId));
            if (limit > 0) {
                query = query.limitToFirst(limit);
            }
            return query.orderByChild('order');
        }

        _fbValue(snap) {
            const data = _.values(snap.val())
                .slice(this.offset || 0);

            if (data.length > 0) {
                data.sort((a, b) => a.order - b.order);
            }

            this.splice('tracks', 0, this.tracks.length, ...data);
        }

        _queryChanged(query, oldQuery) {
            if (oldQuery) {
                oldQuery.off('value');
            }
            if (query) {
                query.on('value', this._fbValue.bind(this));
            }
        }

        _tracksChanged(change) {
            const tracks = change.base;
            this.set('state.currentTrack', (tracks && tracks.length > 0) ? tracks[0] : null);
        }
    }

    customElements.define(TracksProvider.is, TracksProvider);
</script>
