<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../utils/lodash.html">
<link rel="import" href="../behavior-app-state.html">
<link rel="import" href="../behavior-firebase-paths.html">
<link rel="import" href="provider-spotify.html">

<dom-module id="provider-tracks">
    <template>
        <firebase-query path="[[_getFirebaseTracksPath(state.partyId)]]"
                        data="{{_fbTracks}}"
                        order-by-child="order"
                        limit-to-last="[[limit]]">
        </firebase-query>

        <provider-spotify id="spotifyProvider" market="[[state.party.country]]"></provider-spotify>
    </template>
    <script>
        Polymer({
            is: 'provider-tracks',

            behaviors: [
                FestifyBehaviors.FirebasePathsBehavior,
                FestifyBehaviors.StateBehavior
            ],

            properties: {
                _fbTracks: {
                    type: Array
                },
                limit: {
                    type: Number,
                    value: 50
                },
                searchQuery: {
                    type: String,
                    observer: '_searchQueryChanged'
                },
                tracks: {
                    type: Array,
                    notify: true,
                    value: function() {
                        return [];
                    }
                }
            },

            ready: function () {
                this.set('tracks', this._fbTracks);
                this.linkPaths('tracks', '_fbTracks');
            },

            _searchQueryChanged: function (query) {
                this.debounce('searchQueryChanged', function () {
                    if (!query || query.length < 1) {
                        this.set('tracks', this._fbTracks);
                        this.linkPaths('tracks', '_fbTracks');
                        return;
                    }

                    this.unlinkPaths('tracks');
                    this.set('tracks', []);
                    this.splice('tracks', 0, this.tracks.length);

                    [ // Enter the other providers here
                        this.$.spotifyProvider
                    ].map(function (provider) {
                        provider.search(query)
                            .then(function (results) {
                                // Special trick to reduce the amount of pushes to a notifying property.
                                // Once our build toolchain supports ES6, this can be replaced by using
                                // the ...spread operator.
                                results.unshift('tracks');
                                this.push.apply(this, results);
                            }.bind(this))
                            .catch(function (err) {
                                if (err.message == "Request aborted.") {
                                    return Promise.resolve();
                                }
                            });
                    }.bind(this));
                }, 200);
            }
        });
    </script>
</dom-module>
