<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-database-script.html">
<link rel="import" href="../common/behavior-app-state.html">
<link rel="import" href="../common/behavior-firebase-paths.html">
<link rel="import" href="../utils/lodash.html">
<link rel="import" href="playback/playback-controller.html">

<dom-module id="provider-player">
    <template>
        <playback-controller id="playback" config="[[state.config]]"></playback-controller>
    </template>
    <script>
        Polymer({
            is: 'provider-player',

            behaviors: [
                FestifyBehaviors.FirebasePathsBehavior,
                FestifyBehaviors.StateBehavior
            ],

            properties: {
                tracks: {
                    type: Array,
                    notify: true
                },
                _hasInitialized: {
                    type: Boolean,
                    value: false
                },
                _playerState: {
                    type: Object,
                    observer: '_onPlayerState'
                }
            },

            observers: [
                '_enabledChanged(state.isOwner)',
                '_onTracks(tracks.*)'
            ],

            skip: function () {
                if (!this.tracks || this.tracks.length < 1 || !this.state) {
                    return;
                }

                const track = _.assign({}, this.tracks[0]);
                const updateObject = {};

                const tracksPath = this._getFbTracksPath(this.state.partyId);
                const votesPath = this._getFbVotesPath(this.state.partyId);
                updateObject[tracksPath + '/' + track.$key] = null;
                updateObject[votesPath + '/' + track.$key] = null;

                const u = firebase.database()
                    .ref('/')
                    .update(updateObject);
                delete track.$key;
                const w = firebase.database()
                    .ref(this._getFbHistoryPath(this.state.partyId))
                    .push(track);
                return Promise.all([u, w]);
            },

            togglePlay: function() {
                if (this._playerState) {
                    this._setPlayerState(!this._playerState.playing, this._playerState.currentTrack);
                }
            },

            _onPlayerState: function (playerState, oldPlayerState) {
                playerState = playerState || {};
                oldPlayerState = oldPlayerState || {};

                if (!playerState.currentTrack) {
                    return this.$.playback.stop()
                        .then(() => {
                            this.set('state.party.playback', {
                                last_change: Date.now(),
                                last_position_ms: 0,
                                playing: false
                            });
                        });
                } else if (!_.isEqual(
                    this.get('currentTrack.reference', playerState),
                    this.get('currentTrack.reference', oldPlayerState)
                )) {
                    return this.$.playback.play(playerState.currentTrack.reference)
                        .then(() => this.$.playback.getPosition())
                        .then(posMs => {
                            this.set('state.party.playback', {
                                last_change: Date.now(),
                                last_position_ms: posMs,
                                playing: true
                            });
                        })
                        .catch(err => {
                            console.error("Could not play track, the following error occured: ", err);
                            this._setPlayerState(false, playerState.currentTrack);
                            this.fire('player-playbackFailed', err);
                        });
                } else if (playerState.playing != oldPlayerState.playing) {
                    return (playerState.playing ? this.$.playback.play() : this.$.playback.pause())
                        .then(() => this.$.playback.getPosition())
                        .then(posMs => this.set('state.party.playback', {
                            last_change: Date.now(),
                            last_position_ms: posMs,
                            playing: playerState.playing
                        }));
                }
            },

            _onTracks: function(change) {
                if (!change || !change.base) {
                    return;
                }

                if (change.base.length == 0) {
                    this._setPlayerState(false, null);
                } else {
                    this._setPlayerState(
                        this._playerState ? this._playerState.playing : true,
                        change.base[0]
                    );
                }
            },

            _enabledChanged: function(isEnabled) {
                this.debounce('enabledChanged', () => {
                    if (isEnabled) {
                        this.$.playback.init()
                            .then(() => window.fixStatusBar())
                            .then(() => this._hasInitialized = true)
                            .then(() => this._onTracks({ base: this.tracks }))
                            .catch(err => console.error("Could not initialize playback:", err));
                    } else {
                        this.$.playback.deinit()
                            .then(() => this._hasInitialized = false);
                    }
                }, 100);
            },

            _setPlayerState: function(playing, currentTrack) {
                if (!this._hasInitialized) {
                    return;
                }

                this.set('_playerState', {
                    currentTrack: currentTrack,
                    playing: playing
                });
            }
        });
    </script>
</dom-module>
